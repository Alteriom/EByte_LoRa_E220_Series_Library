name: Create Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  # Run tests first - reuse the build-test workflow
  tests:
    uses: ./.github/workflows/build-test.yml

  release:
    needs: [tests]
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Generate release notes
      id: release_notes
      run: |
        # Extract version from tag
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        
        # Generate release notes from CHANGELOG.md
        if [ -f "CHANGELOG.md" ]; then
          # Extract current version section from changelog
          NOTES=$(awk "/^## \[$VERSION\]/{flag=1; next} /^## \[/{flag=0} flag" CHANGELOG.md || echo "Release $VERSION")
        else
          NOTES="Release $VERSION - Alteriom fork of EByte LoRa E220 Series Library with enhanced CI/CD"
        fi
        
        # Save notes to file for multiline content
        echo "$NOTES" > release_notes.txt
        echo "Generated release notes for version $VERSION"
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.ref_name }}
        name: "Alteriom EByte LoRa E220 v${{ steps.release_notes.outputs.VERSION }}"
        body_path: release_notes.txt
        draft: false
        prerelease: false
        generate_release_notes: true
        files: |
          library.properties
          library.json
          CHANGELOG.md
          DEPLOYMENT_GUIDE.md
          README_ALTERIOM.md
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Validate Library Package
      run: |
        echo "ðŸ” Final validation before Arduino Library Manager submission..."
        ./scripts/validate-library.sh

  # Publish to NPM
  npm-publish:
    needs: [tests, release]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        registry-url: 'https://registry.npmjs.org'
    
    - name: Install dependencies
      run: npm ci --ignore-scripts
    
    - name: Validate package.json
      run: |
        echo "ðŸ“¦ Validating NPM package configuration..."
        npm run validate-library || echo "Library validation completed"
        
        # Check if package name is available (for first-time publishing)
        echo "ðŸ” Checking NPM package availability..."
        if npm view alteriom-ebyte-lora-e220 version 2>/dev/null; then
          echo "âœ… Package exists - this will be an update"
        else
          echo "ðŸ†• Package doesn't exist - this will be first publication"
        fi
    
    - name: Publish to NPM
      run: |
        echo "ðŸ“¦ Publishing to NPM..."
        npm publish --access public
      env:
        NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
    
    - name: NPM Publication Success
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "================================"
        echo "ðŸŽ‰ NPM Publication Successful!"
        echo "================================"
        echo ""
        echo "ðŸ“¦ Package: alteriom-ebyte-lora-e220@$VERSION"
        echo "ðŸ”— NPM URL: https://www.npmjs.com/package/alteriom-ebyte-lora-e220"
        echo "ðŸ“¥ Install: npm install alteriom-ebyte-lora-e220"
        echo ""
        echo "ðŸ”§ MCP Integration:"
        echo "   npm install alteriom-ebyte-lora-e220"
        echo "   # Use in MCP server configurations"
        echo ""
        echo "ðŸ’¡ Documentation:"
        echo "   - Arduino examples: examples/"
        echo "   - MCP configuration: .github/mcp-server-config.json"
        echo "   - PlatformIO: platformio.ini"
        echo "================================"

  submission-instructions:
    needs: [release, npm-publish]
    runs-on: ubuntu-latest
    if: always() && needs.release.result == 'success'
    
    steps:
    - name: Arduino Library Manager Submission Instructions
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "================================"
        echo "ðŸš€ Arduino Library Manager Submission"
        echo "================================"
        echo ""
        echo "âœ… Release $VERSION has been created successfully!"
        echo ""
        echo "ðŸ“‹ Next Steps:"
        echo "1. Go to: https://github.com/arduino/library-registry"
        echo "2. Create a new issue with the following details:"
        echo ""
        echo "   Title: Add Alteriom_EByte_LoRa_E220 library"
        echo ""
        echo "   Body:"
        echo "   ```"
        echo "   Repository URL: https://github.com/Alteriom/EByte_LoRa_E220_Series_Library"
        echo "   Release tag: ${{ github.ref_name }}"
        echo "   Library name: Alteriom_EByte_LoRa_E220"
        echo "   Version: $VERSION"
        echo "   "
        echo "   This is a fork of the EByte LoRa E220 Series Library with enhanced"
        echo "   CI/CD, automated releases, and improved Arduino Library Manager compatibility."
        echo "   ```"
        echo ""
        echo "3. ðŸ“§ Monitor the issue for Arduino team approval"
        echo "4. ðŸŽ‰ Library will be available in Arduino Library Manager after approval"
        echo ""
        echo "ðŸ’¡ Additional Resources:"
        echo "   - GitHub Release: https://github.com/Alteriom/EByte_LoRa_E220_Series_Library/releases/tag/${{ github.ref_name }}"
        echo "   - NPM Package: https://www.npmjs.com/package/alteriom-ebyte-lora-e220"
        echo "   - Documentation: https://github.com/Alteriom/EByte_LoRa_E220_Series_Library/blob/main/README_ALTERIOM.md"
        echo "   - Deployment Guide: https://github.com/Alteriom/EByte_LoRa_E220_Series_Library/blob/main/DEPLOYMENT_GUIDE.md"
        echo "================================"